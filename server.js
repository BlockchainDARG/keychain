// server.js

// set up ======================================================================
// get all the tools we need
var express  = require('express');
var app      = express();
var port     = process.env.PORT || 8080;
var mongoose = require('mongoose');
var passport = require('passport');
var flash    = require('connect-flash');

var morgan       = require('morgan');
var cookieParser = require('cookie-parser');
var bodyParser   = require('body-parser');
var session      = require('express-session');
//var Web3 = require('web3');

var configDB = require('./config/database.js');
var LocalStrategy   = require('passport-local').Strategy;
var Web3 = require('web3');
var util = require('ethereumjs-util');
var tx = require('ethereumjs-tx');
var lightwallet = require('eth-lightwallet');
var txutils = lightwallet.txutils;

web3 = new Web3(new Web3.providers.HttpProvider('https://ropsten.infura.io/'));

address = "0xD1E90a9E4Cd458CfFe191FCa01fF641832a9C0dB";
key = "d82530369ecc87b2d9adc9821a4d7246f2bb3cf5c5b55cb3d2224f0138235599";
contractAddress = "0xdA2602561BabeC3BCc3557Db8f7952954424879d";
bytecode = 
'6060604052341561000f57600080fd5b61140c8061001e6000396000f3006060604052600436106100985763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166310e5c4d9811461009d57806340692995146100db5780636f97fbd11461016e578063970a9080146101bf5780639f7c01221461025c578063afd032ed14610331578063b7986b841461034f578063bb77ee041461036d578063f6e3d59514610400575b600080fd5b34156100a857600080fd5b6100c76024600480358281019290820135918135918201910135610434565b604051901515815260200160405180910390f35b34156100e657600080fd5b6100c760046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061048d95505050505050565b341561017957600080fd5b6100c760046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284375094965061075e95505050505050565b34156101ca57600080fd5b6101e5602460048035828101929101359060ff9035166108f6565b60405160208082528190810183818151815260200191508051906020019080838360005b83811015610221578082015183820152602001610209565b50505050905090810190601f16801561024e5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561026757600080fd5b6100c760046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405281815292919060208401838380828437509496506109d795505050505050565b341561033c57600080fd5b6101e56004803560248101910135610e4c565b341561035a57600080fd5b6101e56004803560248101910135610f1a565b341561037857600080fd5b6100c760046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650610fb095505050505050565b341561040b57600080fd5b61041e6004803560248101910135611300565b60405160ff909116815260200160405180910390f35b600060078585604051808383808284378201915050925050509081526020016040519081900390208383604051808383808284378201915050925050509081526020016040519081900390205460ff1695945050505050565b600080836040518082805190602001908083835b602083106104c05780518252601f1990920191602091820191016104a1565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff168061056957506001826040518082805190602001908083835b602083106105305780518252601f199092019160209182019101610511565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff165b1561057657506000610758565b60016000846040518082805190602001908083835b602083106105aa5780518252601f19909201916020918201910161058b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020805460ff1916911515919091179055816003846040518082805190602001908083835b602083106106205780518252601f199092019160209182019101610601565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020908051610664929160200190611333565b50600180836040518082805190602001908083835b602083106106985780518252601f199092019160209182019101610679565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020805460ff1916911515919091179055826004836040518082805190602001908083835b6020831061070e5780518252601f1990920191602091820191016106ef565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020908051610752929160200190611333565b50600190505b92915050565b60006002826040518082805190602001908083835b602083106107925780518252601f199092019160209182019101610773565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff16156107d7575060006108f1565b336008836040518082805190602001908083835b6020831061080a5780518252601f1990920191602091820191016107eb565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020805473ffffffffffffffffffffffffffffffffffffffff191673ffffffffffffffffffffffffffffffffffffffff9290921691909117905560016002836040518082805190602001908083835b602083106108aa5780518252601f19909201916020918201910161088b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020805460ff19169115159190911790555060015b919050565b6108fe6113b1565b600584846040518083838082843782019150509250505090815260200160405190819003902060ff83166064811061093257fe5b018054600260001961010060018416150201909116046020601f820181900481020160405190810160405280929190818152602001828054600181600116156101000203166002900480156109c85780601f1061099d576101008083540402835291602001916109c8565b820191906000526020600020905b8154815290600101906020018083116109ab57829003601f168201915b505050505090505b9392505050565b60006002846040518082805190602001908083835b60208310610a0b5780518252601f1990920191602091820191016109ec565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff168015610ab557506001836040518082805190602001908083835b60208310610a7c5780518252601f199092019160209182019101610a5d565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff165b8015610b2757506001826040518082805190602001908083835b60208310610aee5780518252601f199092019160209182019101610acf565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff165b15610e42576007846040518082805190602001908083835b60208310610b5e5780518252601f199092019160209182019101610b3f565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020836040518082805190602001908083835b60208310610bc25780518252601f199092019160209182019101610ba3565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff1615610e425760016007856040518082805190602001908083835b60208310610c335780518252601f199092019160209182019101610c14565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020836040518082805190602001908083835b60208310610c975780518252601f199092019160209182019101610c78565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020805460ff19169115159190911790553073ffffffffffffffffffffffffffffffffffffffff1663bb77ee0485846000604051602001526040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808060200180602001838103835285818151815260200191508051906020019080838360005b83811015610d6d578082015183820152602001610d55565b50505050905090810190601f168015610d9a5780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b83811015610dd0578082015183820152602001610db8565b50505050905090810190601f168015610dfd5780820380516001836020036101000a031916815260200191505b50945050505050602060405180830381600087803b1515610e1d57600080fd5b6102c65a03f11515610e2e57600080fd5b5050506040518051905050600190506109d0565b5060009392505050565b610e546113b1565b600383836040518083838082843782019150509250505090815260200160405180910390208054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f0d5780601f10610ee257610100808354040283529160200191610f0d565b820191906000526020600020905b815481529060010190602001808311610ef057829003601f168201915b5050505050905092915050565b610f226113b1565b600483836040518083838082843782019150509250505090815260200160405180910390208054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f0d5780601f10610ee257610100808354040283529160200191610f0d565b6000806002846040518082805190602001908083835b60208310610fe55780518252601f199092019160209182019101610fc6565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff16156112f4576006836040518082805190602001908083835b602083106110545780518252601f199092019160209182019101611035565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff169050602060405190810160405280858152506005846040518082805190602001908083835b602083106110d05780518252601f1990920191602091820191016110b1565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405190819003902060ff83166064811061111257fe5b01815181908051611127929160200190611333565b509050506006836040518082805190602001908083835b6020831061115d5780518252601f19909201916020918201910161113e565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040519081900390205460ff166001016006846040518082805190602001908083835b602083106111ca5780518252601f1990920191602091820191016111ab565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020805460ff191660ff9290921691909117905560016007856040518082805190602001908083835b602083106112445780518252601f199092019160209182019101611225565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020846040518082805190602001908083835b602083106112a85780518252601f199092019160209182019101611289565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020805460ff1916911515919091179055600191506112f9565b600091505b5092915050565b600060068383604051808383808284378201915050925050509081526020016040519081900390205460ff169392505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061137457805160ff19168380011785556113a1565b828001600101855582156113a1579182015b828111156113a1578251825591602001919060010190611386565b506113ad9291506113c3565b5090565b60206040519081016040526000815290565b6113dd91905b808211156113ad57600081556001016113c9565b905600a165627a7a72305820b8a5b3d179ef0a80f327090002715f0f1033669e5a594dbf73fee97923292c320029';
interface = 
[{"constant":true,"inputs":[{"name":"resource","type":"string"},{"name":"key","type":"string"}],"name":"Query_access","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"username","type":"string"},{"name":"key","type":"string"}],"name":"Create_username","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"resource","type":"string"}],"name":"Create_resource","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"key","type":"string"},{"name":"index","type":"uint8"}],"name":"Get_access_for_index","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"resource","type":"string"},{"name":"my_pub_key","type":"string"},{"name":"their_pub_key","type":"string"}],"name":"Share_access","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"user","type":"string"}],"name":"Key_for_user","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"key","type":"string"}],"name":"User_for_key","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"resource","type":"string"},{"name":"pub_key","type":"string"}],"name":"Give_access_to_public_key","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"key","type":"string"}],"name":"Num_access_for_user","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"}];


// configuration ===============================================================
mongoose.connect('mongodb://localhost/local'); // connect to our database

require('./config/passport')(passport); // pass passport for configuration

// set up our express application
app.use(morgan('dev')); // log every request to the console
app.use(cookieParser()); // read cookies (needed for auth)
app.use(bodyParser()); // get information from html forms

app.set('view engine', 'ejs'); // set up ejs for templating

// required for passport
app.use(express.static("public"));
app.use(session({ secret: 'ilovescotchscotchyscotchscotch' })); // session secret
app.use(passport.initialize());
app.use(passport.session()); // persistent login sessions
app.use(flash()); // use connect-flash for flash messages stored in session

// routes ======================================================================
require('./app/routes.js')(app, passport); // load our routes and pass in our app and fully configured passport

// launch ======================================================================
app.listen(port);
console.log('The magic happens on port ' + port);
